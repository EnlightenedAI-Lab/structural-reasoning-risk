<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Audit Artifact: REF-MUNI-2024</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111111;
      --muted: #666666;
      --border: #e0e0e0;
      --panel: #f9f9f9;
      --highlight: #000000;
      --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --font-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
      --status-fail: #d32f2f;
      --status-warn: #f57c00;
      --status-pass: #388e3c;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: var(--font-main);
      line-height: 1.5;
      font-size: 14px;
      -webkit-font-smoothing: antialiased;
    }

    /* TOP BAR */
    .instrument-bar {
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      font-family: var(--font-mono);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      gap: 20px;
      color: var(--muted);
      position: sticky;
      top: 0;
      z-index: 100;
      align-items: center;
      flex-wrap: wrap;
    }
    .instrument-bar strong { color: var(--text); font-weight: 600; }
    .back-link {
      text-decoration: none;
      color: var(--highlight);
      border-bottom: 1px solid var(--highlight);
      margin-right: auto;
      white-space: nowrap;
    }

    .container { max-width: 1100px; margin: 0 auto; padding: 40px 20px 100px; }

    /* HEADER BLOCK */
    .audit-header {
      border-bottom: 2px solid var(--text);
      padding-bottom: 18px;
      margin-bottom: 28px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 20px;
      flex-wrap: wrap;
    }
    h1 { font-size: 24px; font-weight: 700; margin-bottom: 6px; letter-spacing: -0.5px; }
    .meta-row { font-family: var(--font-mono); font-size: 12px; color: var(--muted); }
    .verdict-box { text-align: right; }
    .verdict-label {
      font-family: var(--font-mono);
      font-size: 10px;
      text-transform: uppercase;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }
    .verdict-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--status-fail);
      border: 2px solid var(--status-fail);
      padding: 5px 10px;
      display: inline-block;
      white-space: nowrap;
    }

    /* SECTION TITLES */
    h2 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
      padding-bottom: 6px;
      margin: 34px 0 16px 0;
      font-weight: 600;
      font-family: var(--font-mono);
    }

    /* LINKS STRIP */
    .links-strip{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--muted);
    }
    .links-strip a{
      color: var(--highlight);
      text-decoration: none;
      border-bottom:1px solid var(--highlight);
      padding-bottom:1px;
    }
    .links-strip .pill{
      border:1px solid var(--border);
      padding:6px 10px;
      background:#fff;
    }

    /* METRICS GRID */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1px;
      background: var(--border);
      border: 1px solid var(--border);
    }
    .metric-cell { background: #fff; padding: 18px; }
    .m-label {
      font-family: var(--font-mono);
      font-size: 10px;
      text-transform: uppercase;
      color: var(--muted);
      display: block;
      margin-bottom: 8px;
    }
    .m-value { font-size: 24px; font-weight: 700; display: block; margin-bottom: 4px; }
    .m-status {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 2px;
      text-transform: uppercase;
      display:inline-block;
    }
    .s-fail { color: var(--status-fail); background: #ffebee; }
    .s-warn { color: var(--status-warn); background: #fff3e0; }
    .s-pass { color: var(--status-pass); background: #e8f5e9; }

    /* FILTERS */
    .filters{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin: 10px 0 12px 0;
    }
    .filters input, .filters select{
      border:1px solid var(--border);
      padding:10px 12px;
      font-size: 13px;
      width: 280px;
      max-width: 100%;
    }
    .filters .meta{
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--muted);
      margin-left:auto;
      white-space:nowrap;
    }

    /* TRACE TABLE */
    .trace-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .trace-table th {
      text-align: left;
      font-family: var(--font-mono);
      font-size: 10px;
      text-transform: uppercase;
      color: var(--muted);
      padding: 10px;
      border-bottom: 2px solid #000;
    }
    .trace-table td {
      padding: 12px 10px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    .claim-text { font-weight: 500; }
    .evidence-text { color: var(--muted); font-size: 12px; }
    .mono { font-family: var(--font-mono); color: var(--muted); }

    /* GOVERNANCE */
    .gov-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .gov-item { border: 1px solid var(--border); padding: 15px; display: flex; justify-content: space-between; align-items: center; }
    .gov-label { font-size: 13px; font-weight: 600; }
    .gov-status { font-family: var(--font-mono); font-size: 11px; text-transform: uppercase; font-weight: 700; }

    /* FOOTER */
    .footer {
      margin-top: 70px;
      padding-top: 18px;
      border-top: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
    }

    /* RESPONSIVE */
    @media (max-width: 900px) {
      .metrics-grid { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 600px) {
      .metrics-grid { grid-template-columns: 1fr; }
      .verdict-box { text-align: left; }
      .filters .meta { margin-left:0; width:100%; }
    }
  </style>
</head>
<body>

  <div class="instrument-bar">
    <a href="cubics-assurance.html" class="back-link">← BACK TO BRIEF</a>
    <div>INSTRUMENT: <strong>CUBICS ASSURANCE</strong></div>
    <div>MODE: <strong>ARTIFACT INSPECTION</strong></div>
    <div>REF: <strong>MUNI-2024</strong></div>
  </div>

  <div class="container">

    <div class="audit-header">
      <div>
        <h1>Audit Record: Municipal Investment Fund</h1>
        <div class="meta-row" id="metaRow">
          SOURCE: Municipal-Investment-Fund-Slide-Deck-.pdf · CLAIMS: Loading... · DATE: 2026-01-15
        </div>

        <div class="links-strip">
          <div class="pill">
            Public Source:
            <a href="https://coalitionforgreencapital.com/wp-content/uploads/Municipal-Investment-Fund-Slide-Deck-.pdf" target="_blank" rel="noopener">Open PDF</a>
          </div>
          <div class="pill" id="localPdfPill" style="display:none;">
            Local Copy:
            <a href="Municipal-Investment-Fund-Slide-Deck-.pdf" target="_blank" rel="noopener">Open PDF</a>
          </div>
          <div class="pill">
            Data:
            <a href="claim_trace.csv" download>Download CSV</a>
          </div>
        </div>
      </div>

      <div class="verdict-box">
        <span class="verdict-label">Structural Verdict</span>
        <span class="verdict-value" id="verdictValue">DO NOT APPROVE</span>
      </div>
    </div>

    <h2>Method</h2>
    <div style="border:1px solid var(--border); padding:14px; background:#fff; color:var(--muted);">
      <span style="font-family:var(--font-mono); font-size:12px;">
        Method: manual CUBICS Assurance pass on a public infrastructure pitch deck. Signals derived via structured analyst review. Automation pending.
      </span>
    </div>

    <h2>Assurance Signals (Computed)</h2>
    <div class="metrics-grid" id="metricsGrid">
      <div class="metric-cell">
        <span class="m-label">Structural Coherence</span>
        <span class="m-value" id="mCoherence">0.72</span>
        <span class="m-status s-fail" id="mCoherenceStatus">FAIL (&lt; 0.90)</span>
      </div>
      <div class="metric-cell">
        <span class="m-label">Evidence Coverage</span>
        <span class="m-value" id="mCoverage">54%</span>
        <span class="m-status s-fail" id="mCoverageStatus">FAIL (&lt; 95%)</span>
      </div>
      <div class="metric-cell">
        <span class="m-label">Orphan Rate</span>
        <span class="m-value" id="mOrphan">33%</span>
        <span class="m-status s-fail" id="mOrphanStatus">FAIL (&gt; 5%)</span>
      </div>
      <div class="metric-cell">
        <span class="m-label">Overconfidence Gap</span>
        <span class="m-value" id="mOverconf">High</span>
        <span class="m-status s-warn" id="mOverconfStatus">WARN</span>
      </div>
    </div>

    <h2>Claim–Evidence Trace (Full Dataset)</h2>

    <div class="filters">
      <input id="q" placeholder="Search claim text / evidence…" />
      <select id="statusFilter">
        <option value="">All Results</option>
        <option value="SUPPORTED">SUPPORTED</option>
        <option value="UNSUPPORTED">UNSUPPORTED</option>
      </select>
      <div class="meta" id="rowCount">Rows: —</div>
    </div>

    <table class="trace-table">
      <thead>
        <tr>
          <th width="10%">Page</th>
          <th width="55%">Claim</th>
          <th width="25%">Evidence</th>
          <th width="10%">Result</th>
        </tr>
      </thead>
      <tbody id="traceBody">
        </tbody>
    </table>

    <h2>Governance & Accountability Check</h2>
    <div class="gov-grid">
      <div class="gov-item">
        <span class="gov-label">Document Timestamping</span>
        <span class="gov-status" style="color:var(--status-pass)">PRESENT</span>
      </div>
      <div class="gov-item">
        <span class="gov-label">Accountable Owner (CIO/Risk)</span>
        <span class="gov-status" style="color:var(--status-fail)">MISSING</span>
      </div>
    </div>

    <div class="footer">
      <div>GENERATED BY CUBICS ASSURANCE v0.1</div>
      <div id="hashLine">HASH: —</div>
    </div>

  </div>

  <script>
    // ============================================
    // APP LOGIC
    // ============================================
    const el = (id) => document.getElementById(id);

    function badgeClass(result) {
      const r = (result || "").toUpperCase();
      if (r.includes("TRUE") || r.includes("PASS") || r.includes("SUPPORTED")) return "s-pass";
      return "s-fail";
    }

    function renderTrace(data) {
      const q = (el("q").value || "").toLowerCase();
      const sf = (el("statusFilter").value || "").toUpperCase();

      const filtered = data.filter(d => {
        // Map CSV fields: supported -> result
        const claim = (d.claim || "").toLowerCase();
        const evidenceCount = parseInt(d.evidence || "0");
        const isSupported = (d.supported || "").toLowerCase() === "true";
        
        let resultLabel = "UNSUPPORTED";
        if (isSupported) resultLabel = "SUPPORTED";

        let evidenceText = "None detected";
        if (evidenceCount > 0) evidenceText = `Found ${evidenceCount} marker(s)`;

        const matchQ = !q || claim.includes(q);
        
        let matchS = true;
        if (sf === "SUPPORTED") matchS = resultLabel === "SUPPORTED";
        if (sf === "UNSUPPORTED") matchS = resultLabel === "UNSUPPORTED";

        // Store computed values for display
        d.displayResult = resultLabel;
        d.displayEvidence = evidenceText;

        return matchQ && matchS;
      });

      el("rowCount").textContent = `Rows: ${filtered.length}`;
      const tbody = el("traceBody");
      tbody.innerHTML = "";

      filtered.forEach(d => {
        const tr = document.createElement("tr");

        const tdPage = document.createElement("td");
        tdPage.className = "mono";
        tdPage.textContent = d.page;

        const tdClaim = document.createElement("td");
        tdClaim.className = "claim-text";
        tdClaim.textContent = d.claim;

        const tdEv = document.createElement("td");
        tdEv.className = "evidence-text";
        tdEv.textContent = d.displayEvidence;

        const tdRes = document.createElement("td");
        const span = document.createElement("span");
        span.className = `m-status ${badgeClass(d.displayResult)}`;
        span.textContent = d.displayResult;
        tdRes.appendChild(span);

        tr.appendChild(tdPage);
        tr.appendChild(tdClaim);
        tr.appendChild(tdEv);
        tr.appendChild(tdRes);

        tbody.appendChild(tr);
      });
    }

    // CSV PARSER
    function parseCSV(text) {
      const rows = [];
      let i = 0, field = "", row = [], inQuotes = false;
      while (i < text.length) {
        const c = text[i];
        if (c === '"') {
          if (inQuotes && text[i + 1] === '"') { field += '"'; i += 2; continue; }
          inQuotes = !inQuotes; i++; continue;
        }
        if (!inQuotes && c === ",") { row.push(field); field = ""; i++; continue; }
        if (!inQuotes && (c === "\n" || c === "\r")) {
          if (c === "\r" && text[i + 1] === "\n") i++;
          row.push(field); field = ""; rows.push(row); row = []; i++; continue;
        }
        field += c; i++;
      }
      if (field.length || row.length) { row.push(field); rows.push(row); }
      // Remove empty last row if present
      if (rows.length && rows[rows.length - 1].length <= 1) rows.pop();
      return rows;
    }

    function mapCSV(rows) {
      if (!rows.length) return [];
      const header = rows[0].map(h => h.trim().toLowerCase());
      return rows.slice(1).map(r => {
        const obj = {};
        header.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
        return obj;
      });
    }

    async function tryLocalPdf() {
      try {
        const res = await fetch("Municipal-Investment-Fund-Slide-Deck-.pdf", { method: "HEAD" });
        if (res.ok) el("localPdfPill").style.display = "inline-block";
      } catch (_) {}
    }

    async function loadTraceCsv() {
      try {
        // Fetch the REAL CSV file
        const res = await fetch("claim_trace.csv", { cache: "no-store" });
        if (!res.ok) {
            el("rowCount").textContent = "Error loading CSV file";
            return [];
        }
        const text = await res.text();
        const rows = parseCSV(text);
        const data = mapCSV(rows);
        
        // Update header count based on real data
        const meta = el("metaRow").textContent;
        if (meta.includes("CLAIMS: Loading...")) {
            el("metaRow").textContent = meta.replace("CLAIMS: Loading...", `CLAIMS: ${data.length}`);
        }
        
        return data;
      } catch (e) {
        console.error("Error loading CSV:", e);
        return [];
      }
    }

    // BOOTSTRAP
    (async function init() {
      await tryLocalPdf();
      
      const data = await loadTraceCsv();
      renderTrace(data);

      el("q").addEventListener("input", () => renderTrace(data));
      el("statusFilter").addEventListener("change", () => renderTrace(data));
    })();
  </script>

</body>
</html>
